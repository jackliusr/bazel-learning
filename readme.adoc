# Lessons learned during practice bazel

## Beginning Bazel
practices following the book "Beginning Bazel"

## go-grpc-bazel-docker

grpc client and server, put in docker image, protobuffer and generated files from protobuffers, vscode IDE integration

## rule

create customized rules based on rule tutorials from bazel official site.

## Troubeshooting

* bazel query to find dependencies
* build a specific target and find its sources, artifact and output
* try the native way to build in the langauge envirornment such as go build and javac etc.


## vue

## the relative module path issue

```python
#option 1, hang
#https://github.com/bazelbuild/rules_nodejs/issues/1840#issuecomment-619277667
load("@bazel_skylib//rules:write_file.bzl", "write_file")

write_file(
    name = "write_chdir_script",
    out = "chdir.js",
    content = ["process.chdir(__dirname)"],
)

vue-cli-service(
    ...
    args = ["--node_options=--require=./$(execpath chdir.js)"],
    data = ["chdir.js"],
)

#option 2


vue-cli-service(
    ...
    args = [],
    data = [],
    chdir = package_name(),
)

# https://github.com/vuejs/vue-cli/issues/3152#issuecomment-448892609
#VUE_CLI_CONTEXT=/path/to/your/dir /path/to/your/dir/node_modules/.bin/vue-cli-service build


#option 3
#https://github.com/bazelbuild/rules_nodejs/issues/1776#issuecomment-619313234
genrule(
    name = "build",
    outs = ["dist"],
    srcs = ["@npm//:node_modules"] + glob(
        ["**"],
        exclude = ["node_modules/**"],
    ),
    # TODO: external/npm/node_modules is a hardcode path for @npm//:node_modules, should get package path of @npm
    cmd = """
        export PATH=$$PWD/$$(dirname $(location @nodejs//:node_bin)):$$PATH
        vue_cli_service=$$PWD/$(location @npm//:node_modules/.bin/vue-cli-service) outs=$$PWD/$@
        cd frontend && ln -s ../external/npm/node_modules ./ && $$vue_cli_service build --dest $$outs
    """,
    tools = [
        "@npm//:node_modules/.bin/vue-cli-service",
        "@nodejs//:node_bin",
    ],
)

```
